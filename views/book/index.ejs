<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n L√Ω S√°ch</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .book-cover {
        width: 50px;
        height: 70px;
        object-fit: cover;
        border-radius: 4px;
      }
      .desc-text {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow">
      <div class="container">
        <a class="navbar-brand" href="/">üìö Admin Panel</a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/categories">Danh M·ª•c</a>
          <a class="nav-link" href="/books">S√°ch</a>
          <a class="nav-link" href="/comments">B√¨nh lu·∫≠n</a>
          <a class="nav-link" href="/logout">ƒêƒÉng xu·∫•t</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üìñ Kho S√°ch</h2>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addBookModal"
        >
          <i class="fas fa-plus"></i> Th√™m S√°ch M·ªõi
        </button>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th>·∫¢nh</th>
                <th>T√™n S√°ch</th>
                <th>Danh M·ª•c</th>
                <th>L∆∞·ª£t xem</th>
                <th>H√†nh ƒê·ªông</th>
              </tr>
            </thead>
            <tbody>
              <% if(books.length > 0) { %> <% books.forEach(function(book) { %>
              <tr>
                <td>
                  <img
                    src="<%= book.imageUrl %>"
                    class="book-cover"
                    alt="Cover"
                  />
                </td>
                <td>
                  <div class="fw-bold"><%= book.title %></div>
                  <small class="text-muted"><%= book.author %></small>
                </td>
                <td>
                  <span class="badge bg-info text-dark"
                    ><%= book.categoryName %></span
                  >
                </td>
                <td><%= book.viewsCount %></td>
                <td>
                  <a
                    href="/chapters/<%= book.id %>"
                    class="btn btn-sm btn-success"
                    title="Qu·∫£n l√Ω ch∆∞∆°ng"
                  >
                    <i class="fas fa-list-ol"></i> Ch∆∞∆°ng
                  </a>

                  <a
                    href="/books/delete/<%= book.id %>"
                    class="btn btn-sm btn-danger"
                    onclick="return confirm('X√≥a s√°ch n√†y s·∫Ω m·∫•t h·∫øt ch∆∞∆°ng b√™n trong. Ti·∫øp t·ª•c?')"
                  >
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
              <% }); %> <% } else { %>
              <tr>
                <td colspan="5" class="text-center py-4">Ch∆∞a c√≥ s√°ch n√†o.</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addBookModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form
          action="/books/add"
          method="POST"
          enctype="multipart/form-data"
          id="addBookForm"
        >
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Th√™m S√°ch M·ªõi</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">T√™n S√°ch</label>
                  <input
                    type="text"
                    name="title"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">T√°c Gi·∫£</label>
                  <input
                    type="text"
                    name="author"
                    class="form-control"
                    required
                  />
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Thu·ªôc Danh M·ª•c</label>
                <select name="categoryId" class="form-select" required>
                  <% categories.forEach(function(cate) { %>
                  <option value="<%= cate.id %>"><%= cate.category %></option>
                  <% }); %>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">M√¥ T·∫£ Ng·∫Øn</label>
                <textarea
                  name="description"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">·∫¢nh B√¨a (Upload)</label>
                <input
                  type="file"
                  name="coverImage"
                  class="form-control"
                  accept="image/*"
                  required
                  id="imageInput"
                />
                <div class="mt-2">
                  <img
                    id="imagePreview"
                    src="#"
                    alt="·∫¢nh xem tr∆∞·ªõc"
                    style="
                      max-height: 200px;
                      display: none;
                      border-radius: 5px;
                      border: 1px solid #ddd;
                      padding: 2px;
                    "
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">L∆∞u S√°ch</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");

      imageInput.onchange = (evt) => {
        const [file] = imageInput.files;
        if (file) {
          imagePreview.src = URL.createObjectURL(file);
          imagePreview.style.display = "block";
        } else {
          imagePreview.style.display = "none";
        }
      };

      // 2. C·∫§U H√åNH RESET FORM KHI ƒê√ìNG MODAL
      const addBookModal = document.getElementById("addBookModal");
      const addBookForm = document.getElementById("addBookForm");

      // S·ª± ki·ªán 'hidden.bs.modal' l√† s·ª± ki·ªán c·ªßa Bootstrap, ch·∫°y khi modal ƒë√£ ƒë√≥ng ho√†n to√†n
      addBookModal.addEventListener("hidden.bs.modal", function () {
        // a. X√≥a to√†n b·ªô d·ªØ li·ªáu ch·ªØ nh·∫≠p trong form
        addBookForm.reset();

        // b. Reset l·∫°i ph·∫ßn ·∫£nh xem tr∆∞·ªõc v·ªÅ tr·∫°ng th√°i ·∫©n
        imagePreview.src = "#";
        imagePreview.style.display = "none";
      });
    </script>
  </body>
</html>
